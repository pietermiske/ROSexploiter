#!/usr/bin/env python3

import os
from termcolor import colored, cprint

from modulesROS1.toolbox import api

class ROSAnalyser:
    """
    analysing ROS target based on XMLRPC API's
    """

    def __init__(self, master_hosts):
        self.master_hosts = master_hosts


    def systemRecon(self):
        """ sorts and prints getSystemState() information """

        active_nodes = []
        for host, port in self.master_hosts:
            rpc = api.XMLRPC_API(host, port)
            publisher, subscriber, service = rpc.getSystemState()
            [active_nodes.append(publisher[n][1][0]) for n in range(len(publisher)) if publisher[n][1][0] not in active_nodes]
            [active_nodes.append(subscriber[n][1][0]) for n in range(len(subscriber)) if subscriber[n][1][0] not in active_nodes]

            cprint("[+] Enumeration of ROS environment " + host + " successfully completed:\n", 'green', attrs=['bold'])

            teller = 1
            for node in active_nodes:
                print(colored("  [" + str(teller) + "] Node: " + node, 'cyan', attrs=['bold']))
                print(colored("        Publishing to:", 'white', attrs=['bold']))
                for pub in publisher:
                    if node in pub[1]:
                        print("             " + pub[0])
                print(colored("\n        Subscribed to:", 'white', attrs=['bold']))
                for sub in subscriber:
                    if node in sub[1]:
                        print("             " + sub[0])
                print(colored("\n        Services:", 'white', attrs=['bold']))
                for srv in service:
                    if node in srv[1]:
                        print("             " + srv[0])
                print()
                teller += 1


    def topicRecon(self):
        """ sorts and prints getTopicTypes() information """

        vulnerable_topics = ['/sound', '/cmd_vel', '/motor_power']
        for host, port in self.master_hosts:
            rpc = api.XMLRPC_API(host, port)
            topics = rpc.getTopicTypes()

            if len(topics) > 0:
                cprint("\n[+] Identified topics and message types on target: {}".format(host), 'green', attrs=['bold'])
                counter = 1
                for topic in topics:
                    if topic[0] in vulnerable_topics:
                        cprint("    [" + str(counter) + "] [VULNERABLE] '{}' with message type '{}'".
                              format(topic[0], topic[1]), 'red')
                        counter += 1
                    else:
                        print("    [" + str(counter) + "] '{}' with message type '{}'".format(topic[0], topic[1]))
                        counter += 1
            else:
                cprint("\n[-] No active topics are found on the target system: {}".format(host), 'red', attrs=['bold'])


    def nodesAnalyser(self, host, port):
        """ sorts and prints node, URI and PID information """

        rpc = api.XMLRPC_API(host, port)
        nodes = rpc.filterNodes()

        if len(nodes) > 0:
            os.system('clear')
            cprint("\r[+] Running node(s) on target:", 'green', attrs=['bold'])
            counter = 1
            for node in nodes:
                print("    [" + str(counter) + "] Node: {} \n      URI: {} \n      PID: {}".
                              format(node[0], node[1], node[2]))
                counter += 1
        return nodes


    def topicAnalyser(self, host, port, attack):
        """ sorts and prints topic and message type information """

        vulnerable_topics = ['/sound', '/cmd_vel', '/motor_power']
        exploitable_topics = []
        rpc = api.XMLRPC_API(host, port)
        topics = rpc.getTopicTypes()

        if len(topics) > 0 and attack == 'ACI':
            [exploitable_topics.append(topic) for topic in topics if topic[0] in vulnerable_topics]

            if len(exploitable_topics) > 0:
                os.system('clear')
                cprint("\r[+] Topics on target that are vulnerable for ACI attack:", 'green', attrs=['bold'])
                counter = 1
                for topic in exploitable_topics:
                    print("    [" + str(counter) + "] '{}' with message type '{}'".
                                  format(topic[0], topic[1]))
                    counter += 1
            return exploitable_topics

        elif len(topics) > 0 and attack == 'MITM':
            for topic in topics:
                if topic[0] == '/cmd_vel':
                    return True


