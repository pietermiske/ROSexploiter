#!/usr/bin/env python3

import sys
import time
import threading
import os
from termcolor import colored, cprint

from modulesROS1.toolbox import network
from modulesROS1.toolbox import api

class ScannerSupport:
    """
    Collection of support methods for ROSScanner()
    """

    def __init__(self):
        self.found_master_hosts = []
        self.temp_masters_bin = []
        self.port_range_counter = 0
        self.port_range_start = 11303  # CHANGE BACK TO 1024
        self.port_range_end = 11340  # CHANGE BACK TO 65536
        self.stop_scan = False

        self.interface = network.InterfaceScanner().networkInterface('scan')
        self.ipscan = network.IPScanner(self.interface)


    def threadProcess(self, method):
        """ starts second process for animation purposes """

        process = threading.Thread(target=method)
        process.start()
        return process


    def invalidInput(self):
        """ prints invalid input notification """

        sys.stdout.write(colored("\r[!] Invalid input", 'red'))
        time.sleep(1)
        sys.stdout.flush()


    def scanStopped(self):
        """ verifies if the user wants to stop the network scan after a new ROS Master is found """

        os.system('clear')
        cprint("[+] Network scan stopped. {} ROS Master(s) found with URI:".
               format(len(self.found_master_hosts)), 'green', attrs=['bold'])
        for master in self.found_master_hosts:
            cprint("\r    [*] http://{}:{}".format(master[0], master[1]), 'white')



class ROSScanner(ScannerSupport):
    """
    Scans LAN-network for ROS Master URI with the use of NMAP and native ROS1 XMLRPC requests
    """

    def __init__(self):
        super().__init__()


    def defaultMasterFinder(self):
        """ determine default ROS Master  """

        active_hosts = network.NetworkScanner(self.ipscan.ipConstructor(), 11311).nmapScan()
        active_hosts = [h for h in active_hosts if h != self.ipscan.ipGateway()]
        if len(active_hosts) > 0:
            for host in active_hosts:
                rpc = api.XMLRPC_API(host, 11311)
                if rpc.masterCheck() == True:
                    self.found_master_hosts.append([host, 11311])


    def definedMasterFinder(self):
        """ determine custom defined ROS Master """

        for port in range((self.port_range_start + self.port_range_counter), self.port_range_end):
            self.port_range_counter += 1
            if port == 11311:
                continue

            self.temp_masters_bin = []
            active_hosts = network.NetworkScanner(self.ipscan.ipConstructor(), port).nmapScan()
            active_hosts = [h for h in active_hosts if h != self.ipscan.ipGateway()]
            if len(active_hosts) > 0:
                for host in active_hosts:
                    rpc = api.XMLRPC_API(host, port)
                    if rpc.masterCheck() == True:
                        self.found_master_hosts.append([host, port])
                        self.temp_masters_bin.append([host, port])
                return


    def animationDefaultROS(self):
        """ process animation for defaultMasterFinder() """

        chars = "/—\|"
        for c in chars:
            ip_range = self.ipscan.ipConstructor()
            sys.stdout.write(
                colored('\r[' + c + "] " + "Scanning network range {} for default ROS Master on port 11311".
                        format(ip_range), 'white'))
            sys.stdout.flush()
            time.sleep(0.25)


    def animationDefinedROS(self):
        """ process animation for definedMasterFinder() """

        chars = "/—\|"
        for c in chars:
            percentage = self.port_range_counter / (self.port_range_end - self.port_range_start) * 100
            ip_range = self.ipscan.ipConstructor()
            sys.stdout.write(colored(
                '\r[' + c + "] " + "Scanning network range {} for ROS Master on ports 1024-65535. Scan status: [{:.2f}".
                format(ip_range, percentage) + "%]", 'white'))
            sys.stdout.flush()
            time.sleep(0.25)


    def scanControllerROS1(self):
        """ binds all the above methods together and controls the ROS1 scanner processes """

        while True:
            cprint("\n[!] Starting basic network scan..", 'white', attrs=['bold'])
            default_ros_scan = self.threadProcess(self.defaultMasterFinder)
            while default_ros_scan.isAlive():
                self.animationDefaultROS()

            if len(self.found_master_hosts) > 0:
                cprint("\n[+] Scan on default ROS port completed. {} ROS Master(s) found with default URI:".
                       format(len(self.found_master_hosts)), 'green', attrs=['bold'])
                for master in self.found_master_hosts:
                    cprint("\r    [*] http://{}:11311".format(master[0]), 'white')

                while True:
                    varify = str(input(colored("\nDo you want to continue scanning the non-default ROS Master "
                                               "ports 1024-65535 on the network? (Y)es | (N)o: ", 'white')))
                    if varify.lower() not in ['y', 'n']:
                        self.invalidInput()
                    elif varify.lower() == "n":
                        self.scanStopped()
                        return self.found_master_hosts
                    else:
                        break
                break
            else:
                break

        if len(self.found_master_hosts) == 0:
            cprint("\n[-] No default ROS Master found", 'red', attrs=['bold'])

        cprint("\n[!] Starting extensive network scan..", 'white', attrs=['bold'])

        while (self.port_range_start + self.port_range_counter) != self.port_range_end:
            defined_ros_scan = self.threadProcess(self.definedMasterFinder)

            while defined_ros_scan.isAlive():
                self.animationDefinedROS()

            if len(self.temp_masters_bin) > 0 and (self.port_range_start + self.port_range_counter) < self.port_range_end:
                cprint("\n[+] Network scan paused. ROS Master found at:", 'green', attrs=['bold'])
                for master in self.temp_masters_bin:
                    cprint("\r    [*] {}:{}".format(master[0], master[1]), 'white')

                while True:
                    varify = str(input("\nDo you want to continue scanning the network? (Y)es | (N)o: "))
                    if varify.lower() not in ['y', 'n']:
                        self.invalidInput()
                    elif varify.lower() == "n":
                        self.scanStopped()
                        return self.found_master_hosts
                    else:
                        break

            elif len(self.found_master_hosts) > 0 and (self.port_range_start + self.port_range_counter) == self.port_range_end:
                os.system('clear')
                cprint("[+] Network scan completed. {} ROS Master(s) found with URI:".
                       format(len(self.found_master_hosts)), 'green', attrs=['bold'])
                for master in self.found_master_hosts:
                    cprint("    [*] http://{}:{}".format(master[0], master[1]), 'white')
                return self.found_master_hosts

            else:
                cprint("\n[-] No running ROS1 environment found on network: {}".
                       format(self.ipscan.ipConstructor()), 'red', attrs=['bold'])
                time.sleep(1)
                sys.exit("\n[!] Shutting down ROS Exploiter")
