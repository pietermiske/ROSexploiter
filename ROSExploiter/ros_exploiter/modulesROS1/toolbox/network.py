#!/usr/bin/env python3

import nmap
import time
import sys
import netifaces
from netaddr import IPAddress
from termcolor import colored, cprint

class InterfaceScanner:
    """ network interface selection """

    def networkInterface(self, type):
        """ selecting active network interface on attacker system"""

        interfaces = []
        counter = 1

        cprint("\n[!] Active network interface(s):", 'white', attrs=['bold'])
        for i in netifaces.interfaces():
            try:
                print("    [{}] {} {}".format(counter, i, netifaces.ifaddresses(i)[netifaces.AF_INET][0]['addr']))
                interfaces.append(i)
                counter += 1
            except:
                pass

        while True:
            option = 0
            try:
                if type == 'scan':
                    option = int(input("\nSelect interface for scanning the network: "))
                elif type == 'inject':
                    option = int(input("\nSelect interface for ACI attack (monitor mode support not needed): "))

                if option in range(len(interfaces) + 1):
                    return interfaces[(option - 1)]

                else:
                    sys.stdout.write(colored("\r[!] Invalid input", 'red'))
                    time.sleep(1.5)
            except ValueError:
                sys.stdout.write(colored("\r[!] Invalid input", 'red'))
                time.sleep(1.5)


class IPScanner:
    """
    Construct valid LAN IP address
    """

    def __init__(self, interface):

        self.interface = interface
        self.ip = netifaces.ifaddresses(interface)[netifaces.AF_INET][0]['addr']
        self.mask = netifaces.ifaddresses(interface)[netifaces.AF_INET][0]['netmask']
        self.bits = IPAddress(self.mask).netmask_bits()

    def ipConstructor(self):
        """ construct network ip range"""

        return str(".".join(self.ip.split(".", 3)[:3])) + ".1" + "/" + str(self.bits)

    def ipGateway(self):
        """ construct gateway ip address"""

        return str(".".join(self.ip.split(".", 3)[:3])) + ".1"


class NetworkScanner:
    """
    NMAP implementation
    """

    def __init__(self, ipaddr, port):
        self.ipaddr = ipaddr
        self.port = port
        self.nm = nmap.PortScanner()

    def __repr__(self):
        return self.ipaddr, self.port

    def nmapScan(self):
        """ scans LAN with NMAP functions """

        active_hosts = []
        results = self.nm.scan(self.ipaddr, str(self.port), "-T4 -n -Pn")
        for host in results["scan"]:
            if results["scan"][host]['tcp'][self.port]['state'] == "open":
                active_hosts.append(host)
        return active_hosts