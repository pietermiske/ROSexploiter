#!/usr/bin/env python3

import socket
import xmlrpc.client
import logging
from termcolor import colored

class XMLRPC_API:
    """
    Native ROS XMLRPC Master and Slave API's
    """

    def __init__(self, host, port):
        self.logger = logging.getLogger(__name__)
        self.host = host
        self.port = port


    def setupServerProxyMaster(self):
        """ XMLRPC connection Master API's """

        master_uri = "http://" + self.host + ":" + str(self.port)
        master_client = xmlrpc.client.ServerProxy(master_uri)
        socket.setdefaulttimeout(1)
        return master_client


    def setupServerProxyNode(self, node_uri):
        """ XMLRPC connection Slave API's """

        node_client = xmlrpc.client.ServerProxy(node_uri)
        socket.setdefaulttimeout(1)
        return node_client


    def getPid(self, node_uri):
        """ gathers PID of given node (Slave API)"""

        node_client = self.setupServerProxyNode(node_uri)
        try:
            code, msg, pid = node_client.getPid('')
            if code == 1:
                return pid
            else:
                self.logger.critical(
                    colored('[-] Error sending getPid. Code: ' + str(code) + ' Message: ' + msg, 'red'))

        except socket.timeout:
            self.logger.error(colored('[-] Error connecting to XMLRPC server on target system', 'red'))


    def getSystemState(self):
        """ gathers information about complete ROS environment (Master API) """

        master_client = self.setupServerProxyMaster()
        try:
            code, msg, val = master_client.getSystemState('')
            if code == 1:
                publisher = val[0]
                subscriber = val[1]
                service = val[2]
                return publisher, subscriber, service
            else:
                self.logger.critical(
                    colored('[-] Error sending getSystemState. Code: ' + str(code) + ' Message: ' + msg, 'red'))

        except socket.timeout:
            self.logger.error(colored('[-] Error connecting to XMLRPC server on target system', 'red'))


    def shutdown(self, node_uri):
        """ sends shutdown request for given node (Slave API)"""

        node_client = self.setupServerProxyNode(node_uri)
        try:
            code, msg, ignore = node_client.shutdown('', "This robot is not secure!")
            if code == 1:
                return ignore
            else:
                self.logger.critical(
                    colored('[-] Error sending shutdown. Code: ' + str(code) + ' Message: ' + msg, 'red'))

        except socket.timeout:
            self.logger.error(colored('[-] Error connecting to XMLRPC server on target system', 'red'))


    def masterCheck(self):
        """ determines ROS1 environment (Master API) """

        master_client = self.setupServerProxyMaster()
        try:
            code, msg, val = master_client.getSystemState('')
            if code == 1:
                return True
            else:
                self.logger.critical(
                    colored('[-] Error sending getSystemState. Code: ' + str(code) + ' Message: ' + msg, 'red'))

        except socket.timeout:
            self.logger.error(colored('[-] Error connecting to XMLRPC server on target system', 'red'))


    def lookupNode(self, node_name):
        """ gathers URI of specified node (Master API) """

        master_client = self.setupServerProxyMaster()
        try:
            code, msg, uri = master_client.lookupNode('', node_name)
            if code == 1:
                return uri
            else:
                self.logger.critical(
                    colored('[-] Error sending lookupNode. Code: ' + str(code) + ' Message: ' + msg, 'red'))

        except socket.timeout:
            self.logger.error(colored('[-] Error connecting to XMLRPC server on target system', 'red'))


    def filterNodes(self):
        """ gathers information about active nodes + add URI + add PID (Master API) """

        active_nodes = []
        node_names_uri = []
        master_client = self.setupServerProxyMaster()

        try:
            code, msg, val = master_client.getSystemState('')
            if code == 1:
                pubs = val[0]
                subs = val[1]
                [active_nodes.append(pubs[n][1][0]) for n in range(len(pubs)) if pubs[n][1][0] not in active_nodes]
                [active_nodes.append(subs[n][1][0]) for n in range(len(subs)) if subs[n][1][0] not in active_nodes]
                for node in active_nodes:
                    uri = self.lookupNode(node)
                    node_names_uri.append([node, uri, self.getPid(uri)])
                return node_names_uri
            else:
                self.logger.critical(
                    colored('[-] Error sending getSystemState. Code: ' + str(code) + ' Message: ' + msg, 'red'))

        except socket.timeout:
            self.logger.error(colored('[-] Error connecting to XMLRPC server on target system', 'red'))


    def getTopicTypes(self):
        """ gathers information about active topics and there msg types (Master API) """

        master_client = self.setupServerProxyMaster()
        try:
            code, msg, topic_types = master_client.getTopicTypes('')
            if code == 1:
                return topic_types
            else:
                self.logger.critical(
                    colored('[-] Error sending getTopicTypes. Code: ' + str(code) + ' Message: ' + msg, 'red'))

        except socket.timeout:
            self.logger.error(colored('[-] Error connecting to XMLRPC server on target system', 'red'))